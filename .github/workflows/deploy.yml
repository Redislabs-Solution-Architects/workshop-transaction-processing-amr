# GitHub Actions workflow for deploying with Workload Identity Federation (OIDC)
# 
# NOTE: This workflow is provided for future CI/CD use. 
# The workshop currently uses local deployment via ./setup.sh
#
# No secrets needed - uses GitHub's OIDC token to authenticate with Azure!
#
# Setup Instructions:
# 1. Create an App Registration in Azure AD
# 2. Add a Federated Credential for GitHub Actions
# 3. Grant the App Registration access to your subscription
# 4. Set repository variables (not secrets!)
#
# See: docs/CICD_FEDERATED_IDENTITY.md

name: Deploy Workshop

on:
  workflow_dispatch:
    inputs:
      student_name:
        description: 'Student name (lowercase, no spaces)'
        required: true
        type: string
      location:
        description: 'Azure region'
        required: true
        default: 'eastus'
        type: choice
        options:
          - eastus
          - eastus2
          - westus2
          - westeurope
          - northeurope
      action:
        description: 'Action to perform'
        required: true
        default: 'up'
        type: choice
        options:
          - up
          - down

# Required for OIDC token
permissions:
  id-token: write
  contents: read

env:
  # Set these as repository variables (Settings > Secrets and variables > Actions > Variables)
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install azd
        uses: Azure/setup-azd@v1.0.0

      - name: Log in to Azure (Federated Identity)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to azd (Federated Identity)
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Setup Environment
        run: |
          azd env new "${{ inputs.student_name }}-workshop" \
            --location "${{ inputs.location }}" \
            --subscription "$AZURE_SUBSCRIPTION_ID" \
            || azd env select "${{ inputs.student_name }}-workshop"

      - name: Deploy (azd up)
        if: inputs.action == 'up'
        run: azd up --no-prompt
        env:
          AZURE_ENV_NAME: ${{ inputs.student_name }}-workshop

      - name: Destroy (azd down)
        if: inputs.action == 'down'
        run: azd down --force --purge --no-prompt
        env:
          AZURE_ENV_NAME: ${{ inputs.student_name }}-workshop

      - name: Output URLs
        if: inputs.action == 'up'
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| UI | $(azd env get-value UI_URL) |" >> $GITHUB_STEP_SUMMARY
          echo "| API | $(azd env get-value API_URL) |" >> $GITHUB_STEP_SUMMARY
          echo "| Redis Insight | $(azd env get-value REDIS_INSIGHT_URL) |" >> $GITHUB_STEP_SUMMARY
